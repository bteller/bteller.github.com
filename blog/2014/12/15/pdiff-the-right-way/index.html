
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Perceptual Differencing, the Right Way! - Brad Teller</title>
  <meta name="author" content="Brad Teller">

  
  <meta name="description" content="What is Perceptual Differencing Perceptual differencing is a testing technique where browser automation tools take screen captures of the browser &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://bradteller.com/blog/2014/12/15/pdiff-the-right-way/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Brad Teller" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Brad Teller</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="bradteller.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Perceptual Differencing, the Right Way!</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-15T00:00:00-05:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>15</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>12:00 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><h2>What is Perceptual Differencing</h2>

<p>Perceptual differencing is a testing technique where browser automation tools take screen captures of the browser contents during test execution. These captures are then compared with baseline captures, and if the capture matches the baseline, the test is deemed to have passed.</p>

<h2>Why leverage Perceptual Differencing?</h2>

<p>One of the main reasons a human being is required to run manual regression tests is to verify the output of the page is visually correct. We can eliminate this need by leveraging browser automation and perceptual differencing.</p>

<p>Beyond that simple fact, the technique provides a very quick way to verify a lot of your site functionality without having to <code>Assert</code> your life away. Consider a form that should prevent submission when certain input elements contain invalid data or no data at all. You could create assertions for each of the input elements, and maybe compare that with the DOM level changes made to the browser after a failed submission, or you could take a screen capture and verify the functionality with a single image.</p>

<h2>How do I use Perceptual Differencing effectively?</h2>

<p>There are a few things I&rsquo;ve noticed trying to build a reliable perceptual differencing tool.
- Full page screen captures are unreliable.
- Not all browsers support full page screen captures.
- The OS can have an effect on how your pages are rendered, causing perceived differences in the output of the page.
- Browsers take time to load and finalize your page, so the initial capture you take might not be what the end user actually sees.
- Differencing tools, like ImageMagick, do basic comparisons such as comparing the dimensions of an image, but also do other comparisions that consider every pixel. Simply comparing the dimensions of an image is not enough.
- Some of your content will always be dynamic, such as maybe a visit counter, and those elements must be excluded from your captures.</p>

<h3>Working around these issues</h3>

<ul>
<li>Use a browser that supports full page screen captures, like Firefox.</li>
<li>To make full page captures more reliable, take a number of screen captures for every test, waiting a prescribed amount of time between captures, and only send a capture after 3 of these have matched.</li>
<li>Make sure the comparision tool you use considers both the dimensions of the image, and the pixel level differences.</li>
<li>Instead of always taking full page captures, take captures that target specific elements on the page, or others that remove the element completely from your full page capture.</li>
</ul>


<h2>How do I get started with Perceptual Differencing?</h2>

<p>The tools I&rsquo;m using for our perceptual differencing tool at work are:</p>

<ul>
<li><a href="http://docs.seleniumhq.org/">Selenium</a></li>
<li>ImageMagick</li>
<li><a href="http://huddle.github.io/Resemble.js/">Resemble.js</a></li>
<li>SQL Database</li>
<li>Disk Storage</li>
</ul>


<p>Our automated test suite captures difference images and sends those to a web site. That site is then responsible for comparing the capture with the baseline. There is then a web app that provides a dashboard and mechanisms for approving and denying differences, and establishing new baselines.</p>

<p>The code below is a simple extension method to the Selenium <code>IWebDriver</code> that will take up to 10 captures, waiting 1 second between each capture, and return the one that matched 3 times, or the very last capture taken.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="kt">byte</span><span class="p">[]</span> <span class="nf">Diff</span><span class="p">(</span><span class="k">this</span> <span class="n">IWebDriver</span> <span class="n">driver</span><span class="p">,</span> <span class="kt">string</span> <span class="n">name</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">MagickImage</span> <span class="n">baseline</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">var</span> <span class="n">matches</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>    <span class="p">((</span><span class="n">IJavaScriptExecutor</span><span class="p">)</span><span class="n">driver</span><span class="p">).</span><span class="n">ExecuteScript</span><span class="p">(</span><span class="s">&quot;$(&#39;.carousel&#39;).carousel(&#39;pause&#39;);&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">1000</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">capture</span> <span class="p">=</span> <span class="p">((</span><span class="n">ITakesScreenshot</span><span class="p">)</span><span class="n">driver</span><span class="p">).</span><span class="n">GetScreenshot</span><span class="p">().</span><span class="n">AsByteArray</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">baseline</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">baseline</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MagickImage</span><span class="p">(</span><span class="n">capture</span><span class="p">);</span>
</span><span class='line'>            <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">var</span> <span class="n">currentImage</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MagickImage</span><span class="p">(</span><span class="n">capture</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">different</span> <span class="p">=</span> <span class="n">baseline</span><span class="p">.</span><span class="n">CompareTo</span><span class="p">(</span><span class="n">currentImage</span><span class="p">)</span> <span class="p">!=</span> <span class="m">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(!</span><span class="n">different</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">baseline</span><span class="p">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">currentImage</span><span class="p">);</span>
</span><span class='line'>            <span class="n">different</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="n">MeanErrorPerPixel</span> <span class="p">&gt;</span> <span class="m">0.0</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(!</span><span class="n">different</span><span class="p">)</span>
</span><span class='line'>            <span class="n">matches</span><span class="p">++;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">matches</span> <span class="p">&gt;</span> <span class="m">2</span><span class="p">)</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">matches</span> <span class="p">&lt;</span> <span class="m">2</span><span class="p">)</span>
</span><span class='line'>        <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;failed to match&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">baseline</span><span class="p">.</span><span class="n">ToByteArray</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You might have noticed this line of code. Its purose is to disable the Twitter Bootstrap caurousel which might otherwise cause your captures to differ. If you have other dynamic content elements on the page, you should consider hiding them, or disabling them in this manner.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="p">((</span><span class="n">IJavaScriptExecutor</span><span class="p">)</span><span class="n">driver</span><span class="p">).</span><span class="n">ExecuteScript</span><span class="p">(</span><span class="s">&quot;$(&#39;.carousel&#39;).carousel(&#39;pause&#39;);&quot;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The ability to capture full page screen captures or compare image contents isn&rsquo;t specific to Selenium or ImageMagick. You might choose to use PhantomJS for your browser automation, or to use only Resemble.js to compare your images. Instead of using SQL you might want to push your data into a document data store, or store your image captures directly in your database. The choice is yours.</p>

<h2>Conclusion</h2>

<p>Adding perceptual differencing to your existing automated tests is something I would recommend everyone do. With that being said, it doesn&rsquo;t completely eliminate the need for manual testing by a human being. You will always need people to do exploratory testing, to review and approve captures as baselines, to ensure your automation test suite is testing all of what it should test, to approve a build for release, and more of course.</p>

<p>I don&rsquo;t yet have our own internal test tool in a state that I can push it out as an open-source project. Last night I was proving out some consistency issues though, so I had to write a quick stress test app, and that is available on GitHub at <a href="https://github.com/bteller/StressPdiff.">https://github.com/bteller/StressPdiff.</a></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Brad Teller</span></span>

      




<time class='entry-date' datetime='2014-12-15T00:00:00-05:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>15</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>12:00 am</span></time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://bradteller.com/blog/2014/12/15/pdiff-the-right-way/" data-via="bradteller" data-counturl="http://bradteller.com/blog/2014/12/15/pdiff-the-right-way/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/07/02/tfs-build-getting-better/" title="Previous Post: TFS Build Might be Getting Better">&laquo; TFS Build Might be Getting Better</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/07/01/responsive-now/" title="Next Post: Start Planning for Responsive Design, NOW!">Start Planning for Responsive Design, NOW! &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/07/01/responsive-now/">Start Planning for Responsive Design, NOW!</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/15/pdiff-the-right-way/">Perceptual Differencing, the Right Way!</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/02/tfs-build-getting-better/">TFS Build Might Be Getting Better</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/16/maybe-oneget-is-for/">Maybe I Know What OneGet Is For</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/11/what-is-oneget/">OneGet... What For?</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/bteller">@bteller</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'bteller',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Brad Teller -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
